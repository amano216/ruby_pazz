<!DOCTYPE html>
<html>
<head>
  <title>Ruby Interpreter V2 Test</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    .test { margin: 20px 0; padding: 15px; border: 2px solid #ddd; }
    .passed { border-color: #0a0; background: #efe; }
    .failed { border-color: #f00; background: #fee; }
    .title { font-weight: bold; font-size: 1.2em; }
    pre { background: #fff; padding: 10px; border: 1px solid #ccc; }
    .summary { background: #333; color: #fff; padding: 20px; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>🚀 Ruby Interpreter V2 実用レベルテスト</h1>
  <div id="results"></div>
  
  <script src="ruby_interpreter_v2.js"></script>
  <script>
    const interpreter = new RubyInterpreterV2();
    const results = document.getElementById('results');
    
    const tests = [
      {
        title: "演算子の優先順位",
        code: 'puts 2 + 3 * 4',
        expected: "14\n",
        critical: true
      },
      {
        title: "括弧付き演算",
        code: 'puts (2 + 3) * 4',
        expected: "20\n",
        critical: true
      },
      {
        title: "べき乗演算子",
        code: 'puts 2 ** 3',
        expected: "8\n"
      },
      {
        title: "0除算エラー",
        code: 'puts 10 / 0',
        shouldError: true,
        errorMessage: "ゼロ除算エラー",
        critical: true
      },
      {
        title: "整数除算",
        code: 'puts 5 / 2',
        expected: "2\n",
        critical: true
      },
      {
        title: "文字列エスケープ",
        code: 'puts "hello\\nworld"',
        expected: "hello\nworld\n"
      },
      {
        title: "複雑なメソッドチェーン",
        code: 'puts "hello".upcase.reverse.length',
        expected: "5\n",
        critical: true
      },
      {
        title: "nil チェック",
        code: 'x = nil\nputs x.nil?',
        expected: "true\n",
        critical: true
      },
      {
        title: "配列の範囲外アクセス",
        code: 'arr = [1, 2, 3]\nputs arr[10]',
        expected: "\n"
      },
      {
        title: "後置if",
        code: 'puts "hello" if true',
        expected: "hello\n"
      },
      {
        title: "後置unless",
        code: 'puts "world" unless false',
        expected: "world\n"
      },
      {
        title: "case when文",
        code: 'x = 2\ncase x\nwhen 1\n  puts "one"\nwhen 2\n  puts "two"\nelse\n  puts "other"\nend',
        expected: "two\n"
      },
      {
        title: "until ループ",
        code: 'i = 0\nuntil i > 2\n  puts i\n  i += 1\nend',
        expected: "0\n1\n2\n"
      },
      {
        title: "ブロック内の変数スコープ",
        code: 'x = 0\n3.times do\n  x += 1\nend\nputs x',
        expected: "3\n",
        critical: true
      },
      {
        title: "配列のmap",
        code: 'puts [1, 2, 3].map { |n| n * 2 }',
        expected: "[2, 4, 6]\n"
      },
      {
        title: "配列のselect",
        code: 'puts [1, 2, 3, 4, 5].select { |n| n > 3 }',
        expected: "[4, 5]\n"
      },
      {
        title: "デフォルト引数",
        code: 'def greet(name = "World")\n  puts "Hello #{name}"\nend\ngreet()',
        expected: "Hello World\n"
      },
      {
        title: "三項演算子",
        code: 'x = 5\nputs x > 3 ? "big" : "small"',
        expected: "big\n"
      },
      {
        title: "ハッシュの新しい記法",
        code: 'h = {name: "Ruby", version: 3}\nputs h[:name]',
        expected: "Ruby\n"
      },
      {
        title: "break文",
        code: '5.times do |i|\n  break if i == 2\n  puts i\nend',
        expected: "0\n1\n"
      },
      {
        title: "next文",
        code: '3.times do |i|\n  next if i == 1\n  puts i\nend',
        expected: "0\n2\n"
      },
      {
        title: "無限ループ対策（タイムアウト）",
        code: 'while true\n  puts "loop"\nend',
        shouldError: true,
        errorMessage: "実行回数制限"
      },
      {
        title: "文字列の繰り返し",
        code: 'puts "ab" * 3',
        expected: "ababab\n"
      },
      {
        title: "配列の各種メソッド",
        code: 'arr = [3, 1, 2]\nputs arr.sort\nputs arr.max\nputs arr.min',
        expected: "[1, 2, 3]\n3\n1\n"
      },
      {
        title: "数値の各種メソッド",
        code: 'puts (-5).abs\nputs 3.14.round\nputs 10.even?',
        expected: "5\n3\ntrue\n"
      }
    ];
    
    let passedCount = 0;
    let criticalPassed = 0;
    let criticalTotal = 0;
    
    tests.forEach(test => {
      const div = document.createElement('div');
      if (test.critical) criticalTotal++;
      
      try {
        interpreter.reset();
        const result = interpreter.execute(test.code);
        
        if (test.shouldError) {
          div.className = 'test failed';
          div.innerHTML = `
            <div class="title">❌ ${test.title} ${test.critical ? '🔴 CRITICAL' : ''}</div>
            <pre>コード:\n${test.code}</pre>
            <pre>期待: エラー「${test.errorMessage}」\n実際: ${JSON.stringify(result)}</pre>
          `;
        } else {
          const passed = result === test.expected;
          if (passed) {
            passedCount++;
            if (test.critical) criticalPassed++;
          }
          div.className = passed ? 'test passed' : 'test failed';
          div.innerHTML = `
            <div class="title">${passed ? '✅' : '❌'} ${test.title} ${test.critical ? '🔴 CRITICAL' : ''}</div>
            <pre>コード:\n${test.code}</pre>
            <pre>期待: ${JSON.stringify(test.expected)}\n実際: ${JSON.stringify(result)}</pre>
          `;
        }
      } catch (error) {
        if (test.shouldError) {
          const passed = error.message.includes(test.errorMessage);
          if (passed) {
            passedCount++;
            if (test.critical) criticalPassed++;
          }
          div.className = passed ? 'test passed' : 'test failed';
          div.innerHTML = `
            <div class="title">${passed ? '✅' : '❌'} ${test.title} ${test.critical ? '🔴 CRITICAL' : ''}</div>
            <pre>コード:\n${test.code}</pre>
            <pre>正しくエラー: ${error.message}</pre>
          `;
        } else {
          div.className = 'test failed';
          div.innerHTML = `
            <div class="title">❌ ${test.title} ${test.critical ? '🔴 CRITICAL' : ''}</div>
            <pre>コード:\n${test.code}</pre>
            <pre>予期しないエラー: ${error.message}</pre>
          `;
        }
      }
      
      results.appendChild(div);
    });
    
    // サマリー表示
    const summary = document.createElement('div');
    summary.className = 'summary';
    const totalPercentage = Math.round(passedCount / tests.length * 100);
    const criticalPercentage = Math.round(criticalPassed / criticalTotal * 100);
    
    summary.innerHTML = `
      <h2>テスト結果サマリー</h2>
      <p>✅ 全体: ${passedCount}/${tests.length} (${totalPercentage}%)</p>
      <p>🔴 重要項目: ${criticalPassed}/${criticalTotal} (${criticalPercentage}%)</p>
      <hr>
      <h3>改善点：</h3>
      <ul>
        <li>✅ 演算子優先順位の正しい実装</li>
        <li>✅ AST（抽象構文木）ベースのパーサー</li>
        <li>✅ スコープ管理システム</li>
        <li>✅ エラーハンドリングの改善</li>
        <li>✅ セキュリティ対策（実行時間制限、無限ループ検出）</li>
        <li>✅ より多くのRuby構文サポート</li>
      </ul>
      <p><strong>実用レベル達成度: ${totalPercentage >= 80 ? '✅ 実用レベル' : totalPercentage >= 60 ? '⚠️ 準実用レベル' : '❌ 要改善'}</strong></p>
    `;
    results.appendChild(summary);
  </script>
</body>
</html>