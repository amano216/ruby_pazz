<!DOCTYPE html>
<html>
<head>
  <title>Ruby Interpreter V2 Test</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    .test { margin: 20px 0; padding: 15px; border: 2px solid #ddd; }
    .passed { border-color: #0a0; background: #efe; }
    .failed { border-color: #f00; background: #fee; }
    .title { font-weight: bold; font-size: 1.2em; }
    pre { background: #fff; padding: 10px; border: 1px solid #ccc; }
    .summary { background: #333; color: #fff; padding: 20px; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>ğŸš€ Ruby Interpreter V2 å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ãƒ†ã‚¹ãƒˆ</h1>
  <div id="results"></div>
  
  <script src="ruby_interpreter_v2.js"></script>
  <script>
    const interpreter = new RubyInterpreterV2();
    const results = document.getElementById('results');
    
    const tests = [
      {
        title: "æ¼”ç®—å­ã®å„ªå…ˆé †ä½",
        code: 'puts 2 + 3 * 4',
        expected: "14\n",
        critical: true
      },
      {
        title: "æ‹¬å¼§ä»˜ãæ¼”ç®—",
        code: 'puts (2 + 3) * 4',
        expected: "20\n",
        critical: true
      },
      {
        title: "ã¹ãä¹—æ¼”ç®—å­",
        code: 'puts 2 ** 3',
        expected: "8\n"
      },
      {
        title: "0é™¤ç®—ã‚¨ãƒ©ãƒ¼",
        code: 'puts 10 / 0',
        shouldError: true,
        errorMessage: "ã‚¼ãƒ­é™¤ç®—ã‚¨ãƒ©ãƒ¼",
        critical: true
      },
      {
        title: "æ•´æ•°é™¤ç®—",
        code: 'puts 5 / 2',
        expected: "2\n",
        critical: true
      },
      {
        title: "æ–‡å­—åˆ—ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—",
        code: 'puts "hello\\nworld"',
        expected: "hello\nworld\n"
      },
      {
        title: "è¤‡é›‘ãªãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³",
        code: 'puts "hello".upcase.reverse.length',
        expected: "5\n",
        critical: true
      },
      {
        title: "nil ãƒã‚§ãƒƒã‚¯",
        code: 'x = nil\nputs x.nil?',
        expected: "true\n",
        critical: true
      },
      {
        title: "é…åˆ—ã®ç¯„å›²å¤–ã‚¢ã‚¯ã‚»ã‚¹",
        code: 'arr = [1, 2, 3]\nputs arr[10]',
        expected: "\n"
      },
      {
        title: "å¾Œç½®if",
        code: 'puts "hello" if true',
        expected: "hello\n"
      },
      {
        title: "å¾Œç½®unless",
        code: 'puts "world" unless false',
        expected: "world\n"
      },
      {
        title: "case whenæ–‡",
        code: 'x = 2\ncase x\nwhen 1\n  puts "one"\nwhen 2\n  puts "two"\nelse\n  puts "other"\nend',
        expected: "two\n"
      },
      {
        title: "until ãƒ«ãƒ¼ãƒ—",
        code: 'i = 0\nuntil i > 2\n  puts i\n  i += 1\nend',
        expected: "0\n1\n2\n"
      },
      {
        title: "ãƒ–ãƒ­ãƒƒã‚¯å†…ã®å¤‰æ•°ã‚¹ã‚³ãƒ¼ãƒ—",
        code: 'x = 0\n3.times do\n  x += 1\nend\nputs x',
        expected: "3\n",
        critical: true
      },
      {
        title: "é…åˆ—ã®map",
        code: 'puts [1, 2, 3].map { |n| n * 2 }',
        expected: "[2, 4, 6]\n"
      },
      {
        title: "é…åˆ—ã®select",
        code: 'puts [1, 2, 3, 4, 5].select { |n| n > 3 }',
        expected: "[4, 5]\n"
      },
      {
        title: "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°",
        code: 'def greet(name = "World")\n  puts "Hello #{name}"\nend\ngreet()',
        expected: "Hello World\n"
      },
      {
        title: "ä¸‰é …æ¼”ç®—å­",
        code: 'x = 5\nputs x > 3 ? "big" : "small"',
        expected: "big\n"
      },
      {
        title: "ãƒãƒƒã‚·ãƒ¥ã®æ–°ã—ã„è¨˜æ³•",
        code: 'h = {name: "Ruby", version: 3}\nputs h[:name]',
        expected: "Ruby\n"
      },
      {
        title: "breakæ–‡",
        code: '5.times do |i|\n  break if i == 2\n  puts i\nend',
        expected: "0\n1\n"
      },
      {
        title: "nextæ–‡",
        code: '3.times do |i|\n  next if i == 1\n  puts i\nend',
        expected: "0\n2\n"
      },
      {
        title: "ç„¡é™ãƒ«ãƒ¼ãƒ—å¯¾ç­–ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰",
        code: 'while true\n  puts "loop"\nend',
        shouldError: true,
        errorMessage: "å®Ÿè¡Œå›æ•°åˆ¶é™"
      },
      {
        title: "æ–‡å­—åˆ—ã®ç¹°ã‚Šè¿”ã—",
        code: 'puts "ab" * 3',
        expected: "ababab\n"
      },
      {
        title: "é…åˆ—ã®å„ç¨®ãƒ¡ã‚½ãƒƒãƒ‰",
        code: 'arr = [3, 1, 2]\nputs arr.sort\nputs arr.max\nputs arr.min',
        expected: "[1, 2, 3]\n3\n1\n"
      },
      {
        title: "æ•°å€¤ã®å„ç¨®ãƒ¡ã‚½ãƒƒãƒ‰",
        code: 'puts (-5).abs\nputs 3.14.round\nputs 10.even?',
        expected: "5\n3\ntrue\n"
      }
    ];
    
    let passedCount = 0;
    let criticalPassed = 0;
    let criticalTotal = 0;
    
    tests.forEach(test => {
      const div = document.createElement('div');
      if (test.critical) criticalTotal++;
      
      try {
        interpreter.reset();
        const result = interpreter.execute(test.code);
        
        if (test.shouldError) {
          div.className = 'test failed';
          div.innerHTML = `
            <div class="title">âŒ ${test.title} ${test.critical ? 'ğŸ”´ CRITICAL' : ''}</div>
            <pre>ã‚³ãƒ¼ãƒ‰:\n${test.code}</pre>
            <pre>æœŸå¾…: ã‚¨ãƒ©ãƒ¼ã€Œ${test.errorMessage}ã€\nå®Ÿéš›: ${JSON.stringify(result)}</pre>
          `;
        } else {
          const passed = result === test.expected;
          if (passed) {
            passedCount++;
            if (test.critical) criticalPassed++;
          }
          div.className = passed ? 'test passed' : 'test failed';
          div.innerHTML = `
            <div class="title">${passed ? 'âœ…' : 'âŒ'} ${test.title} ${test.critical ? 'ğŸ”´ CRITICAL' : ''}</div>
            <pre>ã‚³ãƒ¼ãƒ‰:\n${test.code}</pre>
            <pre>æœŸå¾…: ${JSON.stringify(test.expected)}\nå®Ÿéš›: ${JSON.stringify(result)}</pre>
          `;
        }
      } catch (error) {
        if (test.shouldError) {
          const passed = error.message.includes(test.errorMessage);
          if (passed) {
            passedCount++;
            if (test.critical) criticalPassed++;
          }
          div.className = passed ? 'test passed' : 'test failed';
          div.innerHTML = `
            <div class="title">${passed ? 'âœ…' : 'âŒ'} ${test.title} ${test.critical ? 'ğŸ”´ CRITICAL' : ''}</div>
            <pre>ã‚³ãƒ¼ãƒ‰:\n${test.code}</pre>
            <pre>æ­£ã—ãã‚¨ãƒ©ãƒ¼: ${error.message}</pre>
          `;
        } else {
          div.className = 'test failed';
          div.innerHTML = `
            <div class="title">âŒ ${test.title} ${test.critical ? 'ğŸ”´ CRITICAL' : ''}</div>
            <pre>ã‚³ãƒ¼ãƒ‰:\n${test.code}</pre>
            <pre>äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: ${error.message}</pre>
          `;
        }
      }
      
      results.appendChild(div);
    });
    
    // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
    const summary = document.createElement('div');
    summary.className = 'summary';
    const totalPercentage = Math.round(passedCount / tests.length * 100);
    const criticalPercentage = Math.round(criticalPassed / criticalTotal * 100);
    
    summary.innerHTML = `
      <h2>ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h2>
      <p>âœ… å…¨ä½“: ${passedCount}/${tests.length} (${totalPercentage}%)</p>
      <p>ğŸ”´ é‡è¦é …ç›®: ${criticalPassed}/${criticalTotal} (${criticalPercentage}%)</p>
      <hr>
      <h3>æ”¹å–„ç‚¹ï¼š</h3>
      <ul>
        <li>âœ… æ¼”ç®—å­å„ªå…ˆé †ä½ã®æ­£ã—ã„å®Ÿè£…</li>
        <li>âœ… ASTï¼ˆæŠ½è±¡æ§‹æ–‡æœ¨ï¼‰ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ãƒ¼ã‚µãƒ¼</li>
        <li>âœ… ã‚¹ã‚³ãƒ¼ãƒ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </li>
        <li>âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„</li>
        <li>âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼ˆå®Ÿè¡Œæ™‚é–“åˆ¶é™ã€ç„¡é™ãƒ«ãƒ¼ãƒ—æ¤œå‡ºï¼‰</li>
        <li>âœ… ã‚ˆã‚Šå¤šãã®Rubyæ§‹æ–‡ã‚µãƒãƒ¼ãƒˆ</li>
      </ul>
      <p><strong>å®Ÿç”¨ãƒ¬ãƒ™ãƒ«é”æˆåº¦: ${totalPercentage >= 80 ? 'âœ… å®Ÿç”¨ãƒ¬ãƒ™ãƒ«' : totalPercentage >= 60 ? 'âš ï¸ æº–å®Ÿç”¨ãƒ¬ãƒ™ãƒ«' : 'âŒ è¦æ”¹å–„'}</strong></p>
    `;
    results.appendChild(summary);
  </script>
</body>
</html>